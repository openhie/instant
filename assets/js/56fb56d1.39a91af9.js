(self.webpackChunkinstant_hie_docs=self.webpackChunkinstant_hie_docs||[]).push([[764],{3905:function(e,n,t){"use strict";t.d(n,{Zo:function(){return m},kt:function(){return u}});var o=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function a(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function p(e,n){if(null==e)return{};var t,o,i=function(e,n){if(null==e)return{};var t,o,i={},r=Object.keys(e);for(o=0;o<r.length;o++)t=r[o],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)t=r[o],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var l=o.createContext({}),s=function(e){var n=o.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):a(a({},n),e)),t},m=function(e){var n=s(e.components);return o.createElement(l.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},d=o.forwardRef((function(e,n){var t=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,m=p(e,["components","mdxType","originalType","parentName"]),d=s(t),u=i,h=d["".concat(l,".").concat(u)]||d[u]||c[u]||r;return t?o.createElement(h,a(a({ref:n},m),{},{components:t})):o.createElement(h,a({ref:n},m))}));function u(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var r=t.length,a=new Array(r);a[0]=d;var p={};for(var l in n)hasOwnProperty.call(n,l)&&(p[l]=n[l]);p.originalType=e,p.mdxType="string"==typeof e?e:i,a[1]=p;for(var s=2;s<r;s++)a[s]=t[s];return o.createElement.apply(null,a)}return o.createElement.apply(null,t)}d.displayName="MDXCreateElement"},9292:function(e,n,t){"use strict";t.r(n),t.d(n,{frontMatter:function(){return a},metadata:function(){return p},toc:function(){return l},default:function(){return m}});var o=t(2122),i=t(9756),r=(t(7294),t(3905)),a={id:"configure-openhim-mapping-mediator",title:"How to configure OpenHIM Mapping Mediator",sidebar_label:"Configure OpenHIM Mapping Mediator",keywords:["Instant OpenHIE","How to","Creating packages","OpenHIM","OpenHIM Mapping Mediator"],description:"How to configure OpenHIM Mapping Mediator"},p={unversionedId:"how-to/configure-openhim-mapping-mediator",id:"how-to/configure-openhim-mapping-mediator",isDocsHomePage:!1,title:"How to configure OpenHIM Mapping Mediator",description:"How to configure OpenHIM Mapping Mediator",source:"@site/docs/how-to/configure-openhim-mapping-mediator.mdx",sourceDirName:"how-to",slug:"/how-to/configure-openhim-mapping-mediator",permalink:"/instant/docs/how-to/configure-openhim-mapping-mediator",editUrl:"https://github.com/openhie/instant/tree/master/docs/docs/how-to/configure-openhim-mapping-mediator.mdx",version:"current",sidebar_label:"Configure OpenHIM Mapping Mediator",frontMatter:{id:"configure-openhim-mapping-mediator",title:"How to configure OpenHIM Mapping Mediator",sidebar_label:"Configure OpenHIM Mapping Mediator",keywords:["Instant OpenHIE","How to","Creating packages","OpenHIM","OpenHIM Mapping Mediator"],description:"How to configure OpenHIM Mapping Mediator"},sidebar:"docs",previous:{title:"How to setup managed Kubernetes in the cloud",permalink:"/instant/docs/how-to/setup-kubernetes-in-cloud"},next:{title:"How to configure the HMIS (DHIS2)",permalink:"/instant/docs/how-to/configure-dhis2"}},l=[{value:"Importing Endpoints",id:"importing-endpoints",children:[{value:"Docker",id:"docker",children:[]}]},{value:"Kubernetes",id:"kubernetes",children:[]},{value:"Useful Links",id:"useful-links",children:[]}],s={toc:l};function m(e){var n=e.components,t=(0,i.Z)(e,["components"]);return(0,r.kt)("wrapper",(0,o.Z)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"The Instant OpenHIE architecture, codebase, and documentation are under active development and are subject to change. While we encourage adoption and extension of the Instant OpenHIE framework, we do not consider this ready for production use at this stage."))),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"http://openhim.org/docs/user-guide/mediators"},"OpenHIM mediators")," are HTTP services that are registered and tracked by the OpenHIM Core. As such, a mediator is not unique in the way it is set up for use in an Instant OpenHIE package. The only requirement is that it be packaged as a Docker image."),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://jembi.github.io/openhim-mediator-mapping"},"OpenHIM Mapping Mediator"),", however, is a bit more sophisticated than the average OpenHIM mediator as it is generic and designed for re-use. This mediator usually requires an endpoint configuration(s) to be imported once the mediator is up and running. The endpoint config payload can be sent as a POST request to the ",(0,r.kt)("inlineCode",{parentName:"p"},"/endpoints")," path of the mediator. For more information on the Mapping Mediator endpoints, read ",(0,r.kt)("a",{parentName:"p",href:"https://jembi.github.io/openhim-mediator-mapping/docs/gettingStarted/endpoints"},"here"),"."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Note: This guide assumes that you have an existing custom package and that the OpenHIM Mapping Mediator is already set up but has not been configured with endpoints.")),(0,r.kt)("h2",{id:"importing-endpoints"},"Importing Endpoints"),(0,r.kt)("h3",{id:"docker"},"Docker"),(0,r.kt)("p",null,"To import the mediator endpoint config in an Instant OpenHIE package we use the Instant OpenHIE Config Importer docker image. In your package source code repository, under the ",(0,r.kt)("inlineCode",{parentName:"p"},"docker")," directory, create an ",(0,r.kt)("inlineCode",{parentName:"p"},"importer")," directory. Your directory structure should now look like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"example-package/\n\u251c\u2500\u2500 docker/\n\u2502   \u251c\u2500\u2500 importer/\n\u2514\u2500\u2500 ...\n")),(0,r.kt)("p",null,"Under the importer subdirectory of the docker directory, add a file named ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-compose.config.yml")," with the following contents:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"version: '3.3'\n\nservices:\n  # container for executing config import scripts for setting up initial config\n  example-endpoint-config-importer:\n    container_name: example-endpoint-config-importer\n    image: jembi/instantohie-config-importer:latest\n    restart: on-failure\n    environment:\n      MEDIATOR_HOSTNAME: 'example-mediator'\n      MEDIATOR_API_PORT: 3003\n    volumes:\n      - type: volume\n        source: instant\n        target: /instant\n    # This command will only attempt to import the covid19immunization-mediator config when the uptime endpoint responds with 200\n    command: sh -c \"wait-on -t 60000 http-get://example-mediator:3003/uptime && sleep 1 && node /instant/example-package/docker/importer/volume/endpoint.js\"\n\nvolumes:\n  instant:\n    external: true\n")),(0,r.kt)("p",null,"The previous example will set up a docker container that will run a custom Node.js script that can send the endpoint config to a running instance of the mediator. The ",(0,r.kt)("inlineCode",{parentName:"p"},"command")," for running this container waits for the mediator to be up and running before the import script (endpoint.js) is started."),(0,r.kt)("p",null,"Next, add the following files under a new volume subdirectory of the docker importer directory (",(0,r.kt)("inlineCode",{parentName:"p"},"docker/importer/volume"),"). Add the following files for the volume directory:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"example-endpoint.json")," - the example endpoint configuration file to be imported. For more details on endpoint configs, visit the ",(0,r.kt)("a",{parentName:"li",href:"https://jembi.github.io/openhim-mediator-mapping/docs/gettingStarted/endpoints"},"OpenHIM Mapping Mediator Endpoint Docs"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"endpoint.js")," - a Node.js script that is capable of importing the ",(0,r.kt)("inlineCode",{parentName:"li"},"example-endpoint.json")," contents into a Mapping Mediator instance.")),(0,r.kt)("p",null,"Finally, update the contents of your docker ",(0,r.kt)("inlineCode",{parentName:"p"},"docker/compose.sh")," script to include the importer docker-compose file. The file could look like the following when updated:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},'#!/bin/bash\n\nsleep 10\n\ncomposeFilePath=$( cd "$(dirname "${BASH_SOURCE[0]}")" ; pwd -P )\n\nif [ "$1" == "init" ]; then\n    docker-compose -p instant -f "$composeFilePath"/docker-compose.yml -f "$composeFilePath"/docker-compose.dev.yml -f "$composeFilePath"/importer/docker-compose.config.yml up -d\nelif [ "$1" == "up" ]; then\n    docker-compose -p instant -f "$composeFilePath"/docker-compose.yml -f "$composeFilePath"/docker-compose.dev.yml up -d\nelif [ "$1" == "down" ]; then\n    docker-compose -p instant -f "$composeFilePath"/docker-compose.yml -f "$composeFilePath"/docker-compose.dev.yml -f "$composeFilePath"/importer/docker-compose.config.yml stop\nelif [ "$1" == "destroy" ]; then\n    docker-compose -p instant -f "$composeFilePath"/docker-compose.yml -f "$composeFilePath"/docker-compose.dev.yml -f "$composeFilePath"/importer/docker-compose.config.yml down\nelse\n    echo "Valid options are: init, up, down, or destroy"\nfi\n')),(0,r.kt)("p",null,"The directory structure should now look like the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"example-package/\n\u251c\u2500\u2500 docker/\n\u2502   \u251c\u2500\u2500 importer/\n\u2502       \u251c\u2500\u2500 volume/\n\u2502           \u251c\u2500\u2500 endpoint.js\n\u2502           \u251c\u2500\u2500 example-endpoint.json\n\u2502       \u251c\u2500\u2500 docker-compose.config.yml\n\u2502   \u251c\u2500\u2500 compose.sh\n\u2502   \u251c\u2500\u2500 ...\n\u251c\u2500\u2500 ...\n")),(0,r.kt)("p",null,"With all of the docker setup in place, it is now time to import the endpoint in Kubernetes."),(0,r.kt)("h2",{id:"kubernetes"},"Kubernetes"),(0,r.kt)("p",null,"For Kubernetes, create an importer directory under the ",(0,r.kt)("inlineCode",{parentName:"p"},"kubernetes")," directory. Under the importer directory, add the following files and directories:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"example-endpoint-importer-job.yaml")," - similar to the ",(0,r.kt)("inlineCode",{parentName:"li"},"docker-compose.config.yml")," of the docker scripts, this file will create a Kubernetes ",(0,r.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/concepts/workloads/controllers/job/"},"job")," that will be responsible for running the ",(0,r.kt)("inlineCode",{parentName:"li"},"endpoint.js")," script."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"k8s.sh")," - to configure, start, and stop the Kubernetes importer jobs."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"kustomization.yaml")," - a tool for customizing Kubernetes configurations. More kubernetes information ",(0,r.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/"},"here"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"volume/")," - this directory will be the same as its docker counterpart. You can copy the docker version and all its contents to this Kubernetes destination.")),(0,r.kt)("p",null,"The package directory structure should now look like the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"example-package/\n\u251c\u2500\u2500 docker/\n\u2502   \u251c\u2500\u2500 importer/\n\u2502       \u251c\u2500\u2500 volume/\n\u2502           \u251c\u2500\u2500 endpoint.js\n\u2502           \u251c\u2500\u2500 example-endpoint.json\n\u2502       \u251c\u2500\u2500 docker-compose.config.yml\n\u2502   \u251c\u2500\u2500 compose.sh\n\u2502   \u251c\u2500\u2500 ...\n\u251c\u2500\u2500 kubernetes/\n\u2502   \u251c\u2500\u2500 importer/\n\u2502       \u251c\u2500\u2500 volume/\n\u2502           \u251c\u2500\u2500 endpoint.js\n\u2502           \u251c\u2500\u2500 example-endpoint.json\n\u2502   \u251c\u2500\u2500 example-endpoint-importer-job.yaml\n\u2502   \u251c\u2500\u2500 k8s.sh\n\u2502   \u251c\u2500\u2500 kustomization.yaml\n\u2502   \u251c\u2500\u2500 ...\n\u251c\u2500\u2500 ...\n")),(0,r.kt)("p",null,"Add the following contents to the ",(0,r.kt)("inlineCode",{parentName:"p"},"example-endpoint-importer-job.yaml")," file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: batch/v1\nkind: Job\nmetadata:\n  name: example-endpoint-importer-job\n  labels:\n    app.kubernetes.io/name: endpoint-importer\n    app.kubernetes.io/instance: example-mapper-endpoint-importer-1\n    app.kubernetes.io/version: '0.1'\n    app.kubernetes.io/component: endpoint-importer\n    package: examplePackage\nspec:\n  backoffLimit: 3\n  template:\n    spec:\n      initContainers:\n        - name: example-check-mapper-status\n          image: busybox:1.28\n          command: ['sh', '-c', 'until telnet mapper-service 3003; do echo Mapping mediator not running yet; sleep 10; done;']\n      containers:\n        - name: example-endpoint-importer\n          image: jembi/instantohie-config-importer:latest\n          args:\n            - sh\n            - -c\n            - wait-on -t 60000 http-get://example-mapper-service:3003/uptime && node endpoint.js\n          env:\n            - name: MEDIATOR_HOST_NAME\n              value: 'example-mapper-service'\n            - name: MEDIATOR_API_PORT\n              value: '3003'\n          volumeMounts:\n            - mountPath: /importer\n              name: example-endpoint-importer\n      restartPolicy: OnFailure\n      volumes:\n        - name: example-endpoint-importer\n          configMap:\n            name: example-endpoint-importer-configmap\n")),(0,r.kt)("p",null,"Just like the docker-compose.config.yml, this script will run a ",(0,r.kt)("inlineCode",{parentName:"p"},"jembi/instantohie-config-importer")," container as a Kubernetes job. The script will wait for the OpenHIM Mapping Mediator service/pod to be ready before it executes the ",(0,r.kt)("inlineCode",{parentName:"p"},"endpoint.js")," script."),(0,r.kt)("p",null,"Add the following code to the ",(0,r.kt)("inlineCode",{parentName:"p"},"kustomization.yml")," file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"configMapGenerator:\n  - name: example-endpoint-importer-configmap\n    files:\n      - ./volume/endpoint.js\n      - ./volume/example-endpoint.json\nresources:\n  - ./example-endpoint-importer-job.yaml\n")),(0,r.kt)("p",null,"This config generates a Kubernetes ",(0,r.kt)("inlineCode",{parentName:"p"},"configMap")," for the ",(0,r.kt)("inlineCode",{parentName:"p"},"example-endpoint-importer")," job based on the contents of the volume folder."),(0,r.kt)("p",null,"Finally, update the ",(0,r.kt)("inlineCode",{parentName:"p"},"k8s.sh")," file with the following script:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},'#!/bin/bash\n\nk8sImporterRootFilePath=$( cd "$(dirname "${BASH_SOURCE[0]}")" ; pwd -P )\n\nif [ "$1" == "up" ]; then\n    kubectl apply -k $k8sImporterRootFilePath\nelif [ "$1" == "clean" ]; then\n    kubectl delete -k $k8sImporterRootFilePath\n    kubectl delete jobs --all\nelse\n    echo "Valid options are: up, or clean"\nfi\n')),(0,r.kt)("p",null,"With everything set up, you should now be able to start Instant OpenHIE with your custom package and the OpenHIM Mapping Mediator should be running and successfully configured."),(0,r.kt)("h2",{id:"useful-links"},"Useful Links"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{href:"https://openhie.github.io/instant/",target:"_blank"},"Instant OpenHIE docs")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{href:"http://openhim.org/",target:"_blank"},"OpenHIM")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{href:"https://jembi.github.io/openhim-mediator-mapping/",target:"_blank"},"OpenHIM Mapping Mediator"))))}m.isMDXComponent=!0}}]);